name: End-to-End Tests

on:
  workflow_dispatch:  # Manual trigger only to conserve Actions minutes

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-test:
    name: Run E2E Tests
    runs-on: windows-latest  # Windows for consistency with dev environment
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: src/backend/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend dependencies
        working-directory: ./src/backend
        run: |
          python -m pip install --upgrade pip

          # Install CPU-only torch (much smaller than CUDA version)
          pip install torch --index-url https://download.pytorch.org/whl/cpu

          # Install core dependencies excluding large models
          grep -v "^https://github.com/explosion/spacy-models" requirements.txt | \
          grep -v "^torch" | \
          pip install -r /dev/stdin

          # Install small spacy models only (non-CUDA)
          pip install https://github.com/explosion/spacy-models/releases/download/de_core_news_sm-3.8.0/de_core_news_sm-3.8.0-py3-none-any.whl
          pip install https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.8.0/en_core_web_sm-3.8.0-py3-none-any.whl

      - name: Setup PostgreSQL
        run: |
          # Use postgres service or mock database for CI
          # Configure connection string via environment variable

      - name: Install Playwright
        working-directory: ./tests/e2e
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Start backend server
        working-directory: ./src/backend
        run: |
          Start-Process powershell -ArgumentList "-Command", "python run_backend.py" -NoNewWindow
          Start-Sleep -Seconds 10
        shell: powershell

      - name: Start frontend server
        working-directory: ./src/frontend
        run: |
          npm install
          Start-Process powershell -ArgumentList "-Command", "npm run dev" -NoNewWindow
          Start-Sleep -Seconds 10
        shell: powershell

      - name: Wait for services to be ready
        run: |
          $maxAttempts = 30
          $attempt = 0

          # Wait for backend
          while ($attempt -lt $maxAttempts) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8000/health" -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "Backend is ready"
                break
              }
            } catch {
              Write-Host "Waiting for backend... attempt $attempt"
            }
            $attempt++
            Start-Sleep -Seconds 2
          }

          # Wait for frontend
          $attempt = 0
          while ($attempt -lt $maxAttempts) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:5173" -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "Frontend is ready"
                break
              }
            } catch {
              Write-Host "Waiting for frontend... attempt $attempt"
            }
            $attempt++
            Start-Sleep -Seconds 2
          }
        shell: powershell

      - name: Run E2E tests
        working-directory: ./tests/e2e
        run: npx playwright test
        env:
          E2E_SMOKE_TESTS: 1
          CI: true
        shell: powershell

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 30

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/e2e/test-results/
          retention-days: 7

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos
          path: tests/e2e/test-results/**/*.webm
          retention-days: 7

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'tests/e2e/playwright-report/index.html';

            if (fs.existsSync(resultsPath)) {
              const comment = `## E2E Test Results

              âœ… Tests completed. View the full report in the artifacts.

              - ðŸ“Š Test Report: Available in workflow artifacts
              - ðŸŽ¬ Videos: Available if tests failed
              - ðŸ“¸ Screenshots: Available if tests failed
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
