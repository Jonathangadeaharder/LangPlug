name: Nightly CI

on:
  schedule:
    - cron: "0 3 * * *"

jobs:
  backend:
    name: Backend Nightly
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: src/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install diff-cover

      - name: Run pytest (in-process integration + API with higher gate)
        env:
          LANGPLUG_SECRET_KEY: test-secret-key-for-ci-only-not-for-production-use
          PYTEST_ADDOPTS: "--cov-branch --cov=api --cov=core --cov=management --cov-report=term-missing --cov-report=xml --cov-fail-under=70"
        run: |
          pytest -q tests/api tests/integration/test_inprocess_*.py

      - name: Generate diff coverage markdown (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --markdown-report diff_coverage.md || true

      - name: Generate branch diff coverage markdown (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --markdown-report branch_diff_coverage.md || true

      - name: Generate overall coverage markdown (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET, sys
          p = 'coverage.xml'
          try:
              root = ET.parse(p).getroot()
          except Exception as e:
              print(f'Cannot parse {p}: {e}')
              sys.exit(0)
          def pct(x):
              try:
                  return f"{float(x)*100:.1f}%"
              except Exception:
                  return 'N/A'
          overall_line = pct(root.get('line-rate', 0))
          overall_branch = pct(root.get('branch-rate', 0))
          packages = []
          for pkg in root.findall('.//packages/package'):
              name = pkg.get('name','')
              lr = pkg.get('line-rate','')
              br = pkg.get('branch-rate','')
              packages.append((name, pct(lr), pct(br)))
          def pick(name):
              for n,lv,bv in packages:
                  if n == name:
                      return lv,bv
              for n,lv,bv in packages:
                  if n.startswith(name + '/'):
                      return lv,bv
              return 'N/A','N/A'
          with open('coverage_comment.md','w', encoding='utf-8') as f:
              f.write('# Coverage Summary\n\n')
              f.write(f'- Overall: Lines {overall_line}, Branches {overall_branch}\n')
              for n in ('api','core','management'):
                  ln, bn = pick(n)
                  f.write(f'- {n}: Lines {ln}, Branches {bn}\n')
              f.write('\n## Diff Coverage\n')
          PY
          if [ -f diff_coverage.md ]; then cat diff_coverage.md >> coverage_comment.md; fi
          echo "" >> coverage_comment.md
          echo "## Diff Branch Coverage" >> coverage_comment.md
          if [ -f branch_diff_coverage.md ]; then cat branch_diff_coverage.md >> coverage_comment.md; fi

      - name: Post coverage comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: src/backend/coverage_comment.md

      - name: Diff coverage (PRs only, 90% min)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --fail-under=90

      - name: Diff branch coverage (PRs only, 80% min)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --fail-under=80

      - name: Per-package diff coverage (lines) 90% min
        if: github.event_name == 'pull_request'
        run: |
          set -e
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}... | tr '\n' ' ')
          echo "Changed files: $CHANGED"
          if echo "$CHANGED" | grep -q '^src/backend/api/'; then
            echo 'Enforcing API diff line coverage >= 90%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --include src/backend/api/* --fail-under=90
          fi
          if echo "$CHANGED" | grep -q '^src/backend/core/'; then
            echo 'Enforcing CORE diff line coverage >= 90%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --include src/backend/core/* --fail-under=90
          fi
          if echo "$CHANGED" | grep -q '^src/backend/management/'; then
            echo 'Enforcing MANAGEMENT diff line coverage >= 90%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --include src/backend/management/* --fail-under=90
          fi

      - name: Per-package diff coverage (branches) 80% min
        if: github.event_name == 'pull_request'
        run: |
          set -e
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}... | tr '\n' ' ')
          if echo "$CHANGED" | grep -q '^src/backend/api/'; then
            echo 'Enforcing API diff branch coverage >= 80%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --include src/backend/api/* --fail-under=80
          fi
          if echo "$CHANGED" | grep -q '^src/backend/core/'; then
            echo 'Enforcing CORE diff branch coverage >= 80%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --include src/backend/core/* --fail-under=80
          fi
          if echo "$CHANGED" | grep -q '^src/backend/management/'; then
            echo 'Enforcing MANAGEMENT diff branch coverage >= 80%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --include src/backend/management/* --fail-under=80
          fi

      - name: Append coverage summary to job summary
        if: always()
        run: |
          if [ -f src/backend/coverage_comment.md ]; then \
            echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY; \
            cat src/backend/coverage_comment.md >> $GITHUB_STEP_SUMMARY; \
          fi

      - name: Upload coverage XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-xml
          path: src/backend/coverage.xml
