name: Status Dashboard

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to analyze (default: 7)'
        required: false
        default: '7'
      detailed_analysis:
        description: 'Include detailed job analysis'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  actions: read

jobs:
  generate-dashboard:
    name: Generate Performance Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Performance Monitoring
        run: |
          chmod +x scripts/monitoring/workflow-performance.sh

      - name: Generate Dashboard Report
        id: dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '7' }}
        run: |
          echo "# ðŸ“Š Workflow Performance Dashboard" > dashboard.md
          echo "" >> dashboard.md
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> dashboard.md
          echo "**Repository:** ${{ github.repository }}" >> dashboard.md
          echo "**Analysis Period:** Last $DAYS_BACK days" >> dashboard.md
          echo "" >> dashboard.md

          # Run monitoring script and capture output
          ./scripts/monitoring/workflow-performance.sh all 2>&1 | \
          sed 's/\x1b\[[0-9;]*m//g' >> dashboard.md || echo "Monitoring script failed" >> dashboard.md

          echo "" >> dashboard.md
          echo "---" >> dashboard.md
          echo "*This dashboard is automatically updated every 6 hours*" >> dashboard.md

      - name: Generate Job Summary
        if: always()
        run: |
          echo "# ðŸ“Š Workflow Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat dashboard.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-dashboard-${{ github.run_number }}
          path: dashboard.md
          retention-days: 30

      - name: Check for Performance Issues
        id: check-issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '7' }}
        run: |
          # Check for workflows with low success rates
          issues_found=false

          echo "ðŸ” Checking for performance issues..."

          # Get workflow success rates
          gh api "repos/${{ github.repository }}/actions/runs" \
            --paginate \
            --jq --arg days "$DAYS_BACK" '
            (.workflow_runs[] |
            select(.created_at | fromdateiso8601 > (now - ($days | tonumber * 86400)))) |
            {workflow_name: .name, conclusion: .conclusion}' | \
          jq -s 'group_by(.workflow_name) |
            map({
              workflow: .[0].workflow_name,
              success_rate: ((map(select(.conclusion == "success")) | length) / length * 100),
              total_runs: length
            }) |
            map(select(.success_rate < 80 and .total_runs >= 3))' > low_success_workflows.json

          if [ -s low_success_workflows.json ] && [ "$(cat low_success_workflows.json)" != "[]" ]; then
            echo "âš ï¸ Found workflows with low success rates:" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "- \(.workflow): \(.success_rate | floor)% success rate"' low_success_workflows.json >> $GITHUB_STEP_SUMMARY
            issues_found=true
          fi

          # Check for long-running workflows
          gh api "repos/${{ github.repository }}/actions/runs" \
            --paginate \
            --jq --arg days "$DAYS_BACK" '
            (.workflow_runs[] |
            select(.created_at | fromdateiso8601 > (now - ($days | tonumber * 86400))) |
            select(.conclusion == "success")) |
            {
              workflow_name: .name,
              duration: ((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601))
            }' | \
          jq -s 'group_by(.workflow_name) |
            map({
              workflow: .[0].workflow_name,
              avg_duration: (map(.duration) | add / length)
            }) |
            map(select(.avg_duration > 1800))' > slow_workflows.json  # > 30 minutes

          if [ -s slow_workflows.json ] && [ "$(cat slow_workflows.json)" != "[]" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ Found slow workflows:" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "- \(.workflow): \(.avg_duration/60 | floor) minutes average"' slow_workflows.json >> $GITHUB_STEP_SUMMARY
            issues_found=true
          fi

          if [ "$issues_found" = "true" ]; then
            echo "issues-found=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Recommendations:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review failing workflows and add retry mechanisms" >> $GITHUB_STEP_SUMMARY
            echo "- Optimize slow workflows with better caching or parallelization" >> $GITHUB_STEP_SUMMARY
            echo "- Consider splitting large workflows into smaller, focused ones" >> $GITHUB_STEP_SUMMARY
          else
            echo "issues-found=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All workflows are performing well!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Issue for Performance Problems
        if: steps.check-issues.outputs.issues-found == 'true' && github.event_name == 'schedule'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open performance issue
          existing_issue=$(gh issue list --label "workflow-performance" --state open --json number --jq '.[0].number // empty')

          if [ -z "$existing_issue" ]; then
            echo "Creating new performance issue..."

            cat > issue_body.md << EOF
          # ðŸš¨ Workflow Performance Issues Detected

          **Detection Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Analysis Period:** Last $DAYS_BACK days

          ## Issues Found

          $(cat low_success_workflows.json | jq -r 'if length > 0 then "### Low Success Rate Workflows\n" + (map("- **\(.workflow)**: \(.success_rate | floor)% success rate (\(.total_runs) runs)") | join("\n")) else "" end')

          $(cat slow_workflows.json | jq -r 'if length > 0 then "### Slow Workflows\n" + (map("- **\(.workflow)**: \(.avg_duration/60 | floor) minutes average duration") | join("\n")) else "" end')

          ## Recommended Actions

          1. **Review failing workflows:**
             - Check recent error logs
             - Add retry mechanisms for flaky tests
             - Improve error handling

          2. **Optimize slow workflows:**
             - Implement better caching strategies
             - Add parallelization where possible
             - Split large workflows into focused smaller ones

          3. **Monitor improvements:**
             - Use \`./scripts/monitoring/workflow-performance.sh\` to track progress
             - Set up alerts for future regressions

          ## Dashboard

          View the latest performance dashboard in the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).

          ---
          *This issue was automatically created by the Status Dashboard workflow.*
          EOF

            gh issue create \
              --title "ðŸš¨ Workflow Performance Issues - $(date '+%Y-%m-%d')" \
              --body-file issue_body.md \
              --label "workflow-performance,automation" \
              --assignee "${{ github.actor }}"

            echo "âœ… Created performance issue"
          else
            echo "Performance issue #$existing_issue already exists, skipping creation"
          fi

  update-repo-status:
    name: Update Repository Status
    runs-on: ubuntu-latest
    needs: generate-dashboard
    if: always()
    steps:
      - name: Update Repository Topics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add workflow optimization topic if not present
          current_topics=$(gh api "repos/${{ github.repository }}" --jq '.topics // []')

          if ! echo "$current_topics" | jq -e 'index("workflow-optimized")' > /dev/null; then
            echo "Adding workflow-optimized topic..."
            updated_topics=$(echo "$current_topics" | jq '. + ["workflow-optimized"]')
            gh api "repos/${{ github.repository }}/topics" \
              --method PUT \
              --field names="$updated_topics" || echo "Failed to update topics"
          fi

      - name: Update README Badge Status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Repository status updated based on workflow performance"
          echo "Dashboard available in workflow artifacts"