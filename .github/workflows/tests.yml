name: CI

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/**.md"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/**.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        test-group: [api, core, services, management, integration]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python
        with:
          python-version: "3.11"
          working-directory: src/backend
          requirements-file: requirements.txt
          install-extras: "diff-cover"
          cache-key: ${{ matrix.test-group }}

      - name: Upload pip install log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-install-log-${{ matrix.test-group }}
          path: src/backend/pip-install.log
          retention-days: 7

      - name: Run pytest (${{ matrix.test-group }})
        working-directory: src/backend
        run: |
          case "${{ matrix.test-group }}" in
            api)
              pytest -q tests/api --cov=api --cov-report=xml --cov-report=html --cov-fail-under=45
              ;;
            core)
              pytest -q tests/core --cov=core --cov-report=xml --cov-report=html --cov-fail-under=25
              ;;
            services)
              pytest -q tests/services --cov=services --cov-report=xml --cov-report=html --cov-fail-under=25
              ;;
            management)
              pytest -q tests/management --cov=management --cov-report=xml --cov-report=html --cov-fail-under=45
              ;;
            integration)
              pytest -q tests/integration/test_inprocess_*.py --cov=api --cov=core --cov=services --cov-report=xml --cov-report=html --cov-fail-under=20
              ;;
          esac
        env:
          LANGPLUG_SECRET_KEY: test-secret-key-for-ci-only-not-for-production-use

      - name: Generate Coverage Report
        uses: ./.github/actions/coverage-report
        with:
          coverage-file: coverage.xml
          working-directory: src/backend
          diff-coverage-threshold: "90"
          branch-coverage-threshold: "80"
          artifact-name: backend-coverage-${{ matrix.test-group }}
          comment-header: coverage-${{ matrix.test-group }}
          packages: api,core,management

      - name: Upload coverage HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-html-${{ matrix.test-group }}
          path: src/backend/htmlcov
          retention-days: 7

  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-node
        with:
          node-version: "20"
          working-directory: src/frontend
          cache-key: ${{ matrix.shard }}

      - name: Run Vitest (shard ${{ matrix.shard }})
        working-directory: src/frontend
        run: yarn test --coverage --shard=${{ matrix.shard }}/2 --coverage.thresholds.lines=0 --coverage.thresholds.functions=0 --coverage.thresholds.branches=0 --coverage.thresholds.statements=0

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-shard-${{ matrix.shard }}
          path: src/frontend/coverage
          retention-days: 7
